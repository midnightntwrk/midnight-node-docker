# If your on windows use wsl / git bash / cygwin / msys2 with direnv

export CFG_PRESET=testnet-02

source ./.envrc.${CFG_PRESET}

# This repository only accepts signed commits:

# point out to users at commit time that commits need to be signed,
# not once they've done many commits and are trying to push a PR:
git config --local commit.gpgSign true
git config --local tag.gpgSign true

# docker on mac expects linux/arm64/v8 but currently we don't publish that build
if [[ "$(uname -s)" == "Darwin" ]] && [[ "$(uname -m)" == "arm64" ]]; then
  export DOCKER_DEFAULT_PLATFORM=linux/arm64
fi

export POSTGRES_HOST="postgres" # TODO: replace with IP or host to postgres connection if not connecting to the docker one.
export POSTGRES_PORT="5432"
export POSTGRES_USER="postgres"

# A random password is used for your safety. Docker (but not podman) exposes
# ports to the internet by default. This needs to be unguessable.
if [ ! -f postgres.password ]; then
    uuidgen | tr -d '-' | head -c 16 > postgres.password
fi
export POSTGRES_PASSWORD="$(cat ./postgres.password)"

export POSTGRES_DB="cexplorer"


# To start with debug logs, add "-l debug" to APPEND_ARGS
# To expose safe rpc method to the host port 9944, add "--unsafe-rpc-external" to APPEND_ARGS or  --validator
export APPEND_ARGS="--allow-private-ip --pool-limit 10 --trie-cache-size 0 --prometheus-external --rpc-external --rpc-cors all"


# Node Key:
# Generate a unique node key for P2P networking
if [ ! -f midnight-node.privatekey ]; then
  # Generate node key using parity/subkey
  DOCKER_DEFAULT_PLATFORM=linux/amd64 docker run --rm docker.io/parity/subkey:latest generate-node-key > midnight-node.privatekey
fi
export NODE_KEY="$(cat ./midnight-node.privatekey)"

# Indexer Values:
if [ ! -f indexer.secret ]; then
  # Generate 32-byte hex secret for indexer
  openssl rand -hex 32 > indexer.secret
fi
export INDEXER_SECRET="$(cat ./indexer.secret)"

#
# Mock mode vs Cardano stack:
# Set USE_MOCK=true to run midnight-node with mock Cardano (fast, for dev/testing)
# Set USE_MOCK=false (default) to run full Cardano stack (real blockchain data)
#
export USE_MOCK=${USE_MOCK:-false}

if [ "$USE_MOCK" = "true" ]; then
  # Mock mode: Skip Cardano services and indexer
  export COMPOSE_PROFILES=""
  export DB_SYNC_POSTGRES_CONNECTION_STRING=""
  echo "üìù Mock mode enabled - midnight-node will use mock Cardano data"
else
  # Cardano stack mode: Run all services
  export COMPOSE_PROFILES="cardano"
  export DB_SYNC_POSTGRES_CONNECTION_STRING="psql://$POSTGRES_USER:$POSTGRES_PASSWORD@$POSTGRES_HOST:$POSTGRES_PORT/$POSTGRES_DB"
fi

#
# Partner chains config:
#
export CARDANO_NETWORK=preview
export CARDANO_IMAGE="ghcr.io/intersectmbo/cardano-node:10.2.1"
export CARDANO_DATA_DIR=./cardano-data
export CARDANO_CONFIG_DIR=./cardano-config/${CARDANO_NETWORK}
